#!/usr/bin/env bash
if [ "$ASDF_ACE_DEBUG" ]; then set -x; fi
set -Eeuo pipefail

# detect the tool name
__dirname="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly __dirname
tool="$(basename "$(dirname "${__dirname}")")"; readonly tool

cd "$__dirname/vars/" # quick hack so we don't have to teach each script its location
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/01-facts.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/02-envvar-duplicates.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/50-transforms.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/99-exports.sh"

export exports
envsubst_shell_format="$(printenv exports | sed 's/\</$/g')"

# shellcheck disable=SC2016
url="$(jq -r --arg t "$tool" '.v0[$t].url' ~/TOOLS.json | envsubst "$envsubst_shell_format")"
curl --fail --silent --location -o "${ASDF_DOWNLOAD_PATH}/asdf-file-fetched-from-server" "$url"
