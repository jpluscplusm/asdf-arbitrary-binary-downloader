#!/usr/bin/env bash
set -Eeuo pipefail

if [ "$ASDF_ACE_DEBUG" ]; then set -x; fi

# detect the tool name
__dirname="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly __dirname
tool="$(basename "$(dirname "${__dirname}")")"; readonly tool

go_goos=$(uname -s); readonly go_goos
go_goarch=$(uname -m)
if [ "$go_goarch" == "x86_64" ]; then
   go_goarch="amd64"
fi
readonly go_goarch
uname_m=$(uname -m); readonly uname_m

VERSION="$ASDF_INSTALL_VERSION"; readonly VERSION; export VERSION
UNAME_M_LC=$(printf "%s" "$uname_m" | tr '[:upper:]' '[:lower:]'); readonly UNAME_M_LC; export UNAME_M_LC
GO_GOOS_LC=$(printf "%s" "$go_goos" | tr '[:upper:]' '[:lower:]'); readonly GO_GOOS_LC; export GO_GOOS_LC
GO_GOARCH_LC=$(printf "%s" "$go_goarch" | tr '[:upper:]' '[:lower:]'); readonly GO_GOARCH_LC; export GO_GOARCH_LC

# shellcheck disable=SC2016
url="$(jq -r --arg t "$tool" '.v0[$t].url' ~/TOOLS.json | envsubst '$VERSION $GO_GOOS_LC $GO_GOARCH_LC $UNAME_M_LC')"
curl --fail --silent --location -o "${ASDF_DOWNLOAD_PATH}/asdf-file-fetched-from-server" "$url"
