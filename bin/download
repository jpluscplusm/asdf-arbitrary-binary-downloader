#!/usr/bin/env bash
if [ "$ASDF_ACE_DEBUG" ]; then set -x; fi
set -Eeuo pipefail

if ! command -v cue >/dev/null; then
    echo "FATAL: The asdf-ace plugin requires the CUE cli in order to operate, but it is not installed." >&2
    echo "FATAL: Please install it from https://cuelang.org/docs/install/#download and try again." >&2
    exit 1
fi

# detect the tool name
__dirname="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly __dirname
tool="$(basename "$(dirname "${__dirname}")")"; readonly tool

config=("$HOME/.tool-sources.asdface.cue" "$__dirname/facts.cue")

sh -ec "$(
    cue export -e "v0.tools.\"$tool\".script.download.sh" \
    --out text \
    --inject-vars \
    --inject uname_m="$(uname -m)" \
    --inject uname_s="$(uname -s)" \
    --inject version="$ASDF_INSTALL_VERSION" \
    --inject download_dir="$ASDF_DOWNLOAD_PATH" \
    "${config[@]}"
)"
