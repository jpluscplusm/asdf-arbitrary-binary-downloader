#!/usr/bin/env bash
if [ "$ASDF_ACE_DEBUG" ]; then set -x; fi
set -Eeuo pipefail

# detect the tool name
__dirname="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly __dirname
tool="$(basename "$(dirname "${__dirname}")")"; readonly tool

if ! command -v cue >/dev/null; then
    echo "FATAL: The asdf-ace plugin requires the CUE cli in order to operate, but it is not installed." >&2
    echo "FATAL: Please install it from https://cuelang.org/docs/install/#download and try again." >&2
    exit 1
fi

config=("$HOME/.tool-sources.asdface.cue" "$__dirname/facts.cue")

url="$(cue export -T -t uname_m="$(uname -m)" -t uname_s="$(uname -s)" -t version="$ASDF_INSTALL_VERSION" -e "v0.tools.\"$tool\".url" --out=text "${config[@]}")"
curl --fail --silent --location -o "${ASDF_DOWNLOAD_PATH}/asdf-file-fetched-from-server" "$url"
