#!/usr/bin/env bash
if [ "$ASDF_ACE_DEBUG" ]; then set -x; fi
set -Eeuo pipefail

# detect the tool name
__dirname="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"; readonly __dirname
tool="$(basename "$(dirname "${__dirname}")")"; readonly tool

cd "$__dirname/vars/" # quick hack so we don't have to teach each script its location
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/01-facts.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/02-envvar-duplicates.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/50-transforms.sh"
# shellcheck source-path=SCRIPTDIR
. "$__dirname/vars/99-exports.sh"

export exports
envsubst_shell_format="$(printenv exports | sed 's/\</$/g')"

# shellcheck disable=SC2016
tar_path="$(jq -r --arg t "$tool" '.v0[$t].tar_path' ~/TOOLS.json | envsubst "$envsubst_shell_format")"
# shellcheck disable=SC2016
bin_name="$(jq -r --arg t "$tool" '.v0[$t].bin_name' ~/TOOLS.json | envsubst "$envsubst_shell_format")"

mkdir "$ASDF_INSTALL_PATH/bin"
cd "$ASDF_INSTALL_PATH/bin"

tar -x -z -f "$ASDF_DOWNLOAD_PATH/asdf-file-fetched-from-server" "$tar_path"
chmod +x "$tar_path"
if [ "$tar_path" != "$bin_name" ]; then
  mv "$tar_path" "$bin_name"
fi
rmdir -p "$(dirname "$tar_path")" 2>/dev/null || true
